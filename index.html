<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bar San Luigi</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; background: #f7f7f7; }
nav { display: flex; background: #333; }
nav button { flex: 1; padding: 15px; border: none; color: white; background: #333; cursor: pointer; font-size: 16px; }
nav button.active { background: #555; }
.page { display: none; padding: 15px; }
.page.active { display: block; }
#product-buttons { display: flex; flex-wrap: wrap; gap: 10px; }
.product-btn { flex: 1 0 30%; padding: 15px; color: white; border: none; font-size: 16px; border-radius: 5px; cursor: pointer; }
#cart { margin-top: 20px; background: white; padding: 10px; border-radius: 5px; }
.cart-item { display: flex; justify-content: space-between; padding: 5px 0; }
.cart-total { font-weight: bold; margin-top: 10px; font-size: 18px; }
button.remove-item { background: red; color: white; border: none; padding: 0 6px; cursor: pointer; }
input, select { padding: 5px; margin: 5px 0; }
#logo-preview { max-height: 80px; display: block; margin: 10px 0; }
@media print {
  nav, .no-print { display: none !important; }
  body { margin: 0; }
}
</style>
</head>
<body>

<nav>
  <button class="active" data-page="home">Home</button>
  <button data-page="settings">Impostazioni</button>
  <button data-page="history">Storico Ordini</button>
</nav>

<!-- HOME -->
<div id="home" class="page active">
  <img id="logo-home" alt="Logo Bar" style="max-height:80px; margin-bottom:10px;">
  <div id="product-buttons"></div>
  <div id="cart">
    <div id="cart-items"></div>
    <div class="cart-total">Totale: € <span id="cart-total">0.00</span></div>
    <button id="print-send" class="no-print" style="margin-top:10px;">Stampa e invia</button>
  </div>
</div>

<!-- IMPOSTAZIONI -->
<div id="settings" class="page">
  <div id="settings-login">
    <input type="password" id="settings-pass" placeholder="Password">
    <button id="login-btn">Entra</button>
  </div>
  <div id="settings-content" style="display:none;">
    <h3>Logo</h3>
    <input type="file" id="logo-upload">
    <img id="logo-preview">
    <button id="delete-logo">Rimuovi Logo</button>

    <h3>Categorie</h3>
    <input type="text" id="cat-name" placeholder="Nome categoria">
    <input type="color" id="cat-color" value="#4444ff">
    <button id="add-cat">Aggiungi categoria</button>
    <div id="cat-list"></div>

    <h3>Prodotti</h3>
    <input type="text" id="prod-name" placeholder="Nome prodotto">
    <input type="number" id="prod-price" placeholder="Prezzo">
    <select id="prod-cat"></select>
    <input type="number" id="prod-qty" placeholder="Quantità (vuoto=∞)">
    <button id="add-prod">Aggiungi prodotto</button>
    <div id="prod-list"></div>
  </div>
</div>

<!-- STORICO -->
<div id="history" class="page">
  <input type="date" id="history-date">
  <button id="history-go">Vai!</button>
  <table border="1" style="margin-top:10px; width:100%;">
    <thead><tr><th>Prodotto</th><th>Quantità</th></tr></thead>
    <tbody id="history-table"></tbody>
  </table>
  <div style="margin-top:10px; font-weight:bold;">Totale: € <span id="history-total">0.00</span></div>
  <button id="export-csv">Esporta CSV</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNtqjDfxsV8TccejiE5Clffd1GvajryiU",
  authDomain: "bar-san-luigi.firebaseapp.com",
  projectId: "bar-san-luigi",
  storageBucket: "bar-san-luigi.appspot.com",
  messagingSenderId: "26384635672",
  appId: "1:26384635672:web:672d98a954aa7e5dcaf06d"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let categories = [];
let products = [];
let cart = [];
let logoUrl = "";

// Logo
async function loadLogo() {
  const docRef = doc(db, "config", "logo");
  const snap = await getDoc(docRef);
  if (snap.exists()) {
    logoUrl = snap.data().url;
    document.getElementById("logo-home").src = logoUrl;
    document.getElementById("logo-preview").src = logoUrl;
  }
}

document.getElementById("logo-upload").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const storageRef = ref(storage, "logo.jpg");
  await uploadBytes(storageRef, file);
  logoUrl = await getDownloadURL(storageRef);
  await setDoc(doc(db, "config", "logo"), { url: logoUrl });
  await loadLogo();
});

document.getElementById("delete-logo").addEventListener("click", async () => {
  try {
    await deleteObject(ref(storage, "logo.jpg"));
  } catch(e){}
  await setDoc(doc(db, "config", "logo"), { url: "" });
  logoUrl = "";
  document.getElementById("logo-home").src = "";
  document.getElementById("logo-preview").src = "";
});

// Categorie
async function loadCategories() {
  const snap = await getDocs(collection(db, "categories"));
  categories = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>a.order-b.order);
  renderCategoriesList();
  renderProductButtons();
  fillCategorySelect();
}

function renderCategoriesList() {
  const div = document.getElementById("cat-list");
  div.innerHTML = "";
  categories.forEach(cat => {
    const el = document.createElement("div");
    el.innerHTML = `<span style="background:${cat.color};color:white;padding:2px 5px;">${cat.name}</span>
      <button onclick="deleteCategory('${cat.id}')">Del</button>`;
    div.appendChild(el);
  });
}
window.deleteCategory = async (id) => {
  await deleteDoc(doc(db, "categories", id));
  loadCategories();
};
document.getElementById("add-cat").onclick = async () => {
  await addDoc(collection(db, "categories"), {
    name: document.getElementById("cat-name").value,
    color: document.getElementById("cat-color").value,
    order: categories.length+1
  });
  loadCategories();
};

// Prodotti
async function loadProducts() {
  const snap = await getDocs(collection(db, "products"));
  products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  renderProductsList();
  renderProductButtons();
}
function renderProductsList() {
  const div = document.getElementById("prod-list");
  div.innerHTML = "";
  products.forEach(p => {
    const cat = categories.find(c => c.id===p.categoryId);
    const color = cat ? cat.color : "#999";
    const activeTxt = p.active ? "On" : "Off";
    div.innerHTML += `<div style="margin:3px 0;">
      <span style="background:${color};color:white;padding:2px 5px;">${p.name}</span> €${p.price.toFixed(2)}
      <button onclick="toggleProduct('${p.id}', ${!p.active})">${activeTxt}</button>
      <button onclick="deleteProduct('${p.id}')">Del</button>
    </div>`;
  });
}
window.toggleProduct = async (id, active) => {
  await updateDoc(doc(db, "products", id), { active });
  loadProducts();
};
window.deleteProduct = async (id) => {
  await deleteDoc(doc(db, "products", id));
  loadProducts();
};
document.getElementById("add-prod").onclick = async () => {
  await addDoc(collection(db, "products"), {
    name: document.getElementById("prod-name").value,
    price: parseFloat(document.getElementById("prod-price").value),
    categoryId: document.getElementById("prod-cat").value,
    qty: document.getElementById("prod-qty").value || null,
    active: true
  });
  loadProducts();
};
function fillCategorySelect() {
  const sel = document.getElementById("prod-cat");
  sel.innerHTML = "";
  categories.forEach(c => {
    sel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
  });
}

// Bottoni prodotti Home
function renderProductButtons() {
  const div = document.getElementById("product-buttons");
  div.innerHTML = "";
  categories.forEach(cat => {
    products.filter(p => p.categoryId===cat.id && p.active).forEach(prod => {
      const btn = document.createElement("button");
      btn.className = "product-btn";
      btn.style.background = cat.color;
      btn.textContent = `${prod.name} €${prod.price.toFixed(2)}`;
      btn.onclick = () => addToCart(prod);
      div.appendChild(btn);
    });
  });
}

// Carrello
function addToCart(prod) {
  const existing = cart.find(i => i.id===prod.id);
  if (existing) existing.qty++;
  else cart.push({ ...prod, qty: 1 });
  renderCart();
}
function renderCart() {
  const div = document.getElementById("cart-items");
  div.innerHTML = "";
  let total = 0;
  cart.forEach(item => {
    total += item.price * item.qty;
    div.innerHTML += `<div class="cart-item">${item.name} x${item.qty} - €${(item.price*item.qty).toFixed(2)}
      <button class="remove-item" onclick="removeFromCart('${item.id}')">-</button></div>`;
  });
  document.getElementById("cart-total").textContent = total.toFixed(2);
}
window.removeFromCart = (id) => {
  cart = cart.map(i => i.id===id ? { ...i, qty: i.qty-1 } : i).filter(i => i.qty>0);
  renderCart();
};

// Stampa
document.getElementById("print-send").onclick = async () => {
  if (cart.length===0) return;
  const order = { items: cart, total: parseFloat(document.getElementById("cart-total").textContent), date: new Date().toISOString() };
  await addDoc(collection(db, "orders"), order);
  const printWindow = window.open("", "_blank");
  printWindow.document.write(`<html><head><title>Scontrino</title></head><body style="font-family:monospace;">
    ${logoUrl ? `<img src="${logoUrl}" style="max-width:100%;"><br>` : ""}
    <h3>Bar San Luigi</h3>${new Date().toLocaleString()}<hr>`);
  cart.forEach(item => {
    printWindow.document.write(`${item.name} x${item.qty} €${(item.price*item.qty).toFixed(2)}<br>`);
  });
  printWindow.document.write(`<hr><strong>TOTALE: €${order.total.toFixed(2)}</strong></body></html>`);
  printWindow.document.close();
  printWindow.print();
  cart = [];
  renderCart();
};

// Storico
document.getElementById("history-go").onclick = async () => {
  const selDate = document.getElementById("history-date").value;
  if (!selDate) return;
  const snap = await getDocs(collection(db, "orders"));
  let total = 0;
  const productsMap = {};
  snap.docs.forEach(docu => {
    const data = docu.data();
    if (data.date.startsWith(selDate)) {
      data.items.forEach(it => {
        productsMap[it.name] = (productsMap[it.name]||0) + it.qty;
        total += it.price * it.qty;
      });
    }
  });
  const tbody = document.getElementById("history-table");
  tbody.innerHTML = "";
  Object.entries(productsMap).forEach(([name, qty]) => {
    tbody.innerHTML += `<tr><td>${name}</td><td>${qty}</td></tr>`;
  });
  document.getElementById("history-total").textContent = total.toFixed(2);
};
document.getElementById("export-csv").onclick = () => {
  const rows = [["Prodotto","Quantità"]];
  document.querySelectorAll("#history-table tr").forEach(tr => {
    const cells = tr.querySelectorAll("td");
    rows.push([cells[0].innerText, cells[1].innerText]);
  });
  let csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "storico.csv";
  a.click();
  URL.revokeObjectURL(url);
};

// Login impostazioni
document.getElementById("login-btn").onclick = () => {
  if (document.getElementById("settings-pass").value === "admin") {
    document.getElementById("settings-login").style.display = "none";
    document.getElementById("settings-content").style.display = "block";
  } else alert("Password errata");
};

// Navigazione
document.querySelectorAll("nav button").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    document.getElementById(btn.dataset.page).classList.add("active");
  };
});

// Avvio
await loadLogo();
await loadCategories();
await loadProducts();
</script>
</body>
</html>
