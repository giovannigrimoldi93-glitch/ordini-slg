<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bar San Luigi</title>
<style>
    body { font-family: Arial, sans-serif; background-color: #f3f3f3; margin: 0; padding: 0; }
    header { background-color: #3f51b5; color: white; padding: 10px; text-align: center; }
    header img { max-height: 60px; display: block; margin: 0 auto 5px; }
    nav { display: flex; background-color: #283593; }
    nav button { flex: 1; padding: 10px; border: none; background-color: #283593; color: white; font-size: 16px; cursor: pointer; }
    nav button.active { background-color: #1a237e; }
    .page { display: none; padding: 15px; }
    .page.active { display: block; }
    .products { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
    .products button { padding: 15px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; color: white; font-weight: bold; }
    .cart { background: white; padding: 10px; margin-top: 15px; border-radius: 5px; }
    .cart table { width: 100%; border-collapse: collapse; }
    .cart th, .cart td { padding: 5px; border-bottom: 1px solid #ddd; text-align: left; }
    .total { text-align: right; font-size: 18px; font-weight: bold; }
    button.print { background-color: #4caf50; color: white; border: none; padding: 10px; margin-top: 10px; cursor: pointer; font-size: 16px; border-radius: 5px; }
    .hidden { display: none; }
    ul { list-style: none; padding: 0; }
    ul li { background: #fff; padding: 5px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
    ul li button { margin-left: 5px; }
</style>
</head>
<body>
<header>
    <img id="barLogo" alt="Logo Bar San Luigi">
    <h1>Bar San Luigi</h1>
</header>
<nav>
    <button data-page="home" class="active">Home</button>
    <button data-page="settings">Impostazioni</button>
    <button data-page="history">Storico ordini</button>
</nav>

<!-- Home -->
<div id="home" class="page active">
    <div class="products" id="productsContainer"></div>
    <div class="cart">
        <table id="cartTable">
            <thead><tr><th>Prodotto</th><th>Qt√†</th><th>Prezzo</th><th></th></tr></thead>
            <tbody></tbody>
        </table>
        <div class="total">Totale: ‚Ç¨ <span id="totalPrice">0.00</span></div>
        <button class="print" id="printAndSend">Stampa e invia</button>
    </div>
</div>

<!-- Impostazioni -->
<div id="settings" class="page">
    <div id="loginSettings">
        <input type="password" id="settingsPassword" placeholder="Password">
        <button id="loginBtn">Accedi</button>
    </div>
    <div id="settingsContent" class="hidden">
        <h2>Gestione categorie</h2>
        <input id="catName" placeholder="Nome categoria">
        <input type="color" id="catColor">
        <input type="number" id="catOrder" placeholder="Ordine esposizione">
        <button id="addCategory">Aggiungi categoria</button>
        <ul id="categoriesList"></ul>

        <h2>Gestione prodotti</h2>
        <input id="prodName" placeholder="Nome prodotto">
        <input type="number" id="prodPrice" placeholder="Prezzo">
        <input type="number" id="prodQty" placeholder="Quantit√† (vuoto = illimitata)">
        <select id="prodCategory"></select>
        <button id="addProduct">Aggiungi prodotto</button>
        <ul id="productsList"></ul>

        <h2>Logo</h2>
        <input type="file" id="logoUpload">
        <button id="clearLogoBtn">Rimuovi logo</button>
    </div>
</div>

<!-- Storico ordini -->
<div id="history" class="page">
    <h2>Storico ordini</h2>
    <input type="date" id="historyDate">
    <button id="loadHistory">Vai!</button>
    <table id="historyTable">
        <thead><tr><th>Prodotto</th><th>Qt√†</th></tr></thead>
        <tbody></tbody>
    </table>
    <div class="total">Totale incasso: ‚Ç¨ <span id="historyTotal">0.00</span></div>
    <button id="exportCSV">Esporta CSV</button>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, deleteDoc, updateDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNtqjDfxsV8TccejiE5Clffd1GvajryiU",
  authDomain: "bar-san-luigi.firebaseapp.com",
  projectId: "bar-san-luigi",
  storageBucket: "bar-san-luigi.firebasestorage.app",
  messagingSenderId: "26384635672",
  appId: "1:26384635672:web:672d98a954aa7e5dcaf06d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let logoDataUrl = null;
let categories = [];
let products = [];
let cart = [];

async function loadLogo(){
    try{
        const snap = await getDoc(doc(db,'config','logo'));
        if(snap.exists() && snap.data().url){
            logoDataUrl = snap.data().url;
            document.getElementById("barLogo").src = logoDataUrl;
        }
    } catch(e){ console.error(e); }
}

document.getElementById("logoUpload").onchange = async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    try {
        const refPath = storageRef(storage, 'logos/barLogo.jpg');
        await uploadBytes(refPath, f);
        const url = await getDownloadURL(refPath);
        await setDoc(doc(db,'config','logo'), {url});
        logoDataUrl = url;
        document.getElementById("barLogo").src = logoDataUrl;
        alert('Logo caricato.');
    } catch(err) { console.error(err); }
};

document.getElementById("clearLogoBtn").onclick = async ()=>{
    try {
        const refPath = storageRef(storage, 'logos/barLogo.jpg');
        await deleteObject(refPath);
        await setDoc(doc(db,'config','logo'), {url:null});
        document.getElementById("barLogo").src = '';
        alert('Logo rimosso.');
    } catch(err) { console.error(err); }
};

async function loadCategories(){
    const snap = await getDocs(collection(db, "categories"));
    categories = snap.docs.map(d => ({id:d.id, ...d.data()}));
    categories.sort((a,b) => a.order - b.order);
    updateCategorySelect();
    renderCategoriesList();
}

async function loadProducts(){
    const snap = await getDocs(collection(db, "products"));
    products = snap.docs.map(d => ({id:d.id, ...d.data()}));
    renderProducts();
    renderProductsList();
}

function updateCategorySelect(){
    const sel = document.getElementById("prodCategory");
    sel.innerHTML = "";
    categories.forEach(c=>{
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.name;
        sel.appendChild(opt);
    });
}

function renderProducts(){
    const container = document.getElementById("productsContainer");
    container.innerHTML = "";
    let sorted = [...products].sort((a,b)=>{
        let catA = categories.find(c=>c.id===a.categoryId);
        let catB = categories.find(c=>c.id===b.categoryId);
        return (catA?.order || 0) - (catB?.order || 0);
    });
    sorted.forEach(p=>{
        let cat = categories.find(c=>c.id===p.categoryId);
        const btn = document.createElement("button");
        btn.textContent = p.name;
        btn.style.backgroundColor = cat ? cat.color : "#777";
        btn.onclick = ()=>addToCart(p);
        container.appendChild(btn);
    });
}

function renderCategoriesList(){
    const ul = document.getElementById("categoriesList");
    ul.innerHTML = "";
    categories.forEach(c=>{
        let li = document.createElement("li");
        li.innerHTML = `${c.name} <div><button onclick="editCategory('${c.id}')">‚úè</button><button onclick="deleteCategory('${c.id}')">üóë</button></div>`;
        ul.appendChild(li);
    });
}

function renderProductsList(){
    const ul = document.getElementById("productsList");
    ul.innerHTML = "";
    products.forEach(p=>{
        let li = document.createElement("li");
        li.innerHTML = `${p.name} (‚Ç¨${p.price.toFixed(2)}) <div><button onclick="editProduct('${p.id}')">‚úè</button><button onclick="deleteProduct('${p.id}')">üóë</button></div>`;
        ul.appendChild(li);
    });
}

function addToCart(product){
    let found = cart.find(c=>c.id===product.id);
    if(found){
        found.qty++;
    } else {
        cart.push({...product, qty:1});
    }
    renderCart();
}

function renderCart(){
    const tbody = document.querySelector("#cartTable tbody");
    tbody.innerHTML = "";
    let total = 0;
    cart.forEach((item, idx)=>{
        let tr = document.createElement("tr");
        tr.innerHTML = `<td>${item.name}</td><td>${item.qty}</td><td>‚Ç¨ ${(item.price*item.qty).toFixed(2)}</td>
        <td><button onclick="removeFromCart(${idx})">-</button></td>`;
        total += item.price*item.qty;
        tbody.appendChild(tr);
    });
    document.getElementById("totalPrice").textContent = total.toFixed(2);
}

window.removeFromCart = function(index){
    cart.splice(index,1);
    renderCart();
}

document.getElementById("printAndSend").onclick = async ()=>{
    if(cart.length===0) return;
    let order = {
        items: cart.map(c=>({name:c.name, qty:c.qty, price:c.price})),
        total: cart.reduce((s,c)=>s+c.price*c.qty,0),
        date: new Date().toISOString()
    };
    await addDoc(collection(db,"orders"), order);
    printReceipt(order);
    cart = [];
    renderCart();
};

function printReceipt(order){
    let printWin = window.open("", "", "width=400,height=600");
    let html = `<div style='font-family:monospace;text-align:center;width:80mm;'>
        ${logoDataUrl ? `<img src='${logoDataUrl}' style='max-width:80mm;'>` : ""}
        <h2>Bar San Luigi</h2>
        <p>${new Date().toLocaleString()}</p>
        <hr>`;
    order.items.forEach(it=>{
        html += `<div style='display:flex;justify-content:space-between;'>
            <span>${it.qty}x ${it.name}</span><span>‚Ç¨ ${(it.price*it.qty).toFixed(2)}</span></div>`;
    });
    html += `<hr><h3 style='text-align:right;'>Totale: ‚Ç¨ ${order.total.toFixed(2)}</h3></div>`;
    printWin.document.write(html);
    printWin.print();
    printWin.close();
}

// Impostazioni
document.getElementById("loginBtn").onclick = ()=>{
    if(document.getElementById("settingsPassword").value === "admin"){
        document.getElementById("loginSettings").classList.add("hidden");
        document.getElementById("settingsContent").classList.remove("hidden");
    } else {
        alert("Password errata!");
    }
};

document.getElementById("addCategory").onclick = async ()=>{
    let name = document.getElementById("catName").value;
    let color = document.getElementById("catColor").value;
    let order = parseInt(document.getElementById("catOrder").value)||0;
    await addDoc(collection(db,"categories"), {name,color,order});
    await loadCategories();
};

document.getElementById("addProduct").onclick = async ()=>{
    let name = document.getElementById("prodName").value;
    let price = parseFloat(document.getElementById("prodPrice").value);
    let qty = document.getElementById("prodQty").value ? parseInt(document.getElementById("prodQty").value) : null;
    let categoryId = document.getElementById("prodCategory").value;
    await addDoc(collection(db,"products"), {name,price,qty,categoryId});
    await loadProducts();
};

window.deleteCategory = async function(id){
    await deleteDoc(doc(db,"categories",id));
    await loadCategories();
    renderProducts();
};

window.deleteProduct = async function(id){
    await deleteDoc(doc(db,"products",id));
    await loadProducts();
};

// Storico
document.getElementById("loadHistory").onclick = async ()=>{
    let dateSel = document.getElementById("historyDate").value;
    if(!dateSel) return;
    let qSnap = await getDocs(collection(db,"orders"));
    let filtered = [];
    qSnap.forEach(docSnap=>{
        let d = new Date(docSnap.data().date);
        if(d.toISOString().slice(0,10) === dateSel) filtered.push(docSnap.data());
    });
    let prodMap = {};
    let total = 0;
    filtered.forEach(o=>{
        total += o.total;
        o.items.forEach(it=>{
            prodMap[it.name] = (prodMap[it.name]||0) + it.qty;
        });
    });
    const tbody = document.querySelector("#historyTable tbody");
    tbody.innerHTML = "";
    for(let [name,qty] of Object.entries(prodMap)){
        let tr = document.createElement("tr");
        tr.innerHTML = `<td>${name}</td><td>${qty}</td>`;
        tbody.appendChild(tr);
    }
    document.getElementById("historyTotal").textContent = total.toFixed(2);
};

document.getElementById("exportCSV").onclick = ()=>{
    let rows = [["Prodotto","Quantit√†"]];
    document.querySelectorAll("#historyTable tbody tr").forEach(tr=>{
        let cols = tr.querySelectorAll("td");
        rows.push([cols[0].innerText, cols[1].innerText]);
    });
    let csvContent = rows.map(r=>r.join(",")).join("\n");
    let blob = new Blob([csvContent], {type:"text/csv"});
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "storico.csv";
    a.click();
};

document.querySelectorAll("nav button").forEach(btn=>{
    btn.onclick = ()=>{
        document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
        document.getElementById(btn.dataset.page).classList.add("active");
    };
});

await loadLogo();
await loadCategories();
await loadProducts();
</script>
</body>
</html>
