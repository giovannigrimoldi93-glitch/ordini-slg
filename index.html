<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Bar San Luigi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ===== STILE ORIGINALE ===== -->
<style>
    body { font-family: Arial, sans-serif; background-color: #f5f5f5; margin: 0; padding: 0; }
    header { background-color: #333; color: white; padding: 10px; text-align: center; display: flex; flex-direction: column; align-items: center; }
    header img { max-height: 80px; margin-bottom: 5px; }
    nav { display: flex; justify-content: center; background-color: #444; }
    nav button { padding: 10px 15px; border: none; background-color: #444; color: white; cursor: pointer; font-size: 16px; }
    nav button.active { background-color: #666; }
    .page { display: none; padding: 15px; }
    .page.active { display: block; }
    .product-btn { padding: 15px; margin: 5px; border: none; color: white; font-size: 18px; cursor: pointer; border-radius: 8px; min-width: 100px; }
    #cart { background-color: white; padding: 10px; margin-top: 15px; border-radius: 8px; }
    #cart table { width: 100%; }
    #cart th, #cart td { padding: 5px; text-align: left; }
    .form-section { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
    .form-section input, .form-section select, .form-section button { margin: 5px 0; padding: 8px; font-size: 16px; }
    table { border-collapse: collapse; width: 100%; background: white; }
    table, th, td { border: 1px solid #ddd; }
    th, td { padding: 8px; }
    tfoot { font-weight: bold; }
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header>
    <img id="bar-logo" src="" alt="Logo Bar San Luigi">
    <h1>Bar San Luigi</h1>
</header>

<!-- ===== NAVIGAZIONE ===== -->
<nav>
    <button data-page="home" class="active">Home</button>
    <button data-page="settings">Impostazioni</button>
    <button data-page="history">Storico Ordini</button>
</nav>

<!-- ===== PAGINA HOME ===== -->
<div id="home" class="page active">
    <div id="products-container"></div>
    <div id="cart">
        <h3>Carrello</h3>
        <table id="cart-table">
            <thead><tr><th>Prodotto</th><th>Q.t√†</th><th>Prezzo</th><th></th></tr></thead>
            <tbody></tbody>
        </table>
        <h3>Totale: ‚Ç¨ <span id="cart-total">0.00</span></h3>
        <button id="print-send">Stampa e invia</button>
    </div>
</div>

<!-- ===== PAGINA IMPOSTAZIONI ===== -->
<div id="settings" class="page">
    <div id="login-section" class="form-section">
        <h3>Accesso Impostazioni</h3>
        <input type="password" id="settings-password" placeholder="Password">
        <button id="login-btn">Entra</button>
    </div>

    <div id="settings-content" style="display:none;">
        <!-- Caricamento logo -->
        <div class="form-section">
            <h3>Logo</h3>
            <input type="file" id="logo-input" accept="image/*">
            <button id="upload-logo-btn">Carica Logo</button>
        </div>

        <!-- Categorie -->
        <div class="form-section">
            <h3>Categorie</h3>
            <input type="text" id="category-name" placeholder="Nome categoria">
            <input type="color" id="category-color">
            <input type="number" id="category-order" placeholder="Ordine">
            <button id="add-category-btn">Aggiungi Categoria</button>
            <ul id="categories-list"></ul>
        </div>

        <!-- Prodotti -->
        <div class="form-section">
            <h3>Prodotti</h3>
            <input type="text" id="product-name" placeholder="Nome prodotto">
            <input type="number" id="product-price" placeholder="Prezzo">
            <input type="number" id="product-stock" placeholder="Q.t√† (vuoto = illimitata)">
            <select id="product-category"></select>
            <button id="add-product-btn">Aggiungi Prodotto</button>
            <ul id="products-list"></ul>
        </div>
    </div>
</div>

<!-- ===== PAGINA STORICO ===== -->
<div id="history" class="page">
    <div class="form-section">
        <h3>Storico ordini</h3>
        <input type="date" id="history-date">
        <button id="load-history-btn">Vai!</button>
    </div>
    <div class="form-section">
        <table id="history-table">
            <thead><tr><th>Prodotto</th><th>Quantit√†</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td>Totale incasso</td><td id="history-total">‚Ç¨ 0.00</td></tr></tfoot>
        </table>
        <button id="export-csv-btn">Esporta CSV</button>
    </div>
</div>

<!-- ===== SCRIPT JS ===== -->
<script type="module">
/* =======================
   INIZIALIZZAZIONE FIREBASE
   ======================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

// Configurazione Firebase
const firebaseConfig = {
    apiKey: "AIzaSyDNtqjDfxsV8TccejiE5Clffd1GvajryiU",
    authDomain: "bar-san-luigi.firebaseapp.com",
    projectId: "bar-san-luigi",
    storageBucket: "bar-san-luigi.appspot.com",
    messagingSenderId: "26384635672",
    appId: "1:26384635672:web:672d98a954aa7e5dcaf06d"
};

// Inizializza
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* =======================
   NAVIGAZIONE TRA PAGINE
   ======================= */
document.querySelectorAll("nav button").forEach(btn => {
    btn.addEventListener("click", () => {
        document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
        document.getElementById(btn.dataset.page).classList.add("active");
    });
});

/* =======================
   LOGIN IMPOSTAZIONI
   ======================= */
const settingsPassword = "admin";
document.getElementById("login-btn").addEventListener("click", () => {
    if (document.getElementById("settings-password").value === settingsPassword) {
        document.getElementById("login-section").style.display = "none";
        document.getElementById("settings-content").style.display = "block";
        loadCategories();
        loadProducts();
        loadLogo();
    } else {
        alert("Password errata");
    }
});

/* =======================
   GESTIONE LOGO
   ======================= */
async function loadLogo() {
    try {
        const url = await getDownloadURL(ref(storage, "logo.png"));
        document.getElementById("bar-logo").src = url;
    } catch (e) {
        console.log("Nessun logo trovato");
    }
}

document.getElementById("upload-logo-btn").addEventListener("click", async () => {
    const file = document.getElementById("logo-input").files[0];
    if (!file) return alert("Seleziona un file");
    const storageRef = ref(storage, "logo.png");
    await uploadBytes(storageRef, file);
    loadLogo();
    alert("Logo caricato");
});

/* =======================
   CATEGORIE
   ======================= */
async function loadCategories() {
    const snap = await getDocs(collection(db, "categories"));
    const list = document.getElementById("categories-list");
    const select = document.getElementById("product-category");
    list.innerHTML = "";
    select.innerHTML = "";
    const cats = [];
    snap.forEach(docSnap => {
        const c = { id: docSnap.id, ...docSnap.data() };
        cats.push(c);
    });
    cats.sort((a, b) => a.order - b.order);
    cats.forEach(cat => {
        // Lista per impostazioni
        const li = document.createElement("li");
        li.innerHTML = `<input type="text" value="${cat.name}" data-id="${cat.id}" class="edit-cat-name">
                        <input type="color" value="${cat.color}" data-id="${cat.id}" class="edit-cat-color">
                        <input type="number" value="${cat.order}" data-id="${cat.id}" class="edit-cat-order">
                        <button class="save-cat" data-id="${cat.id}">üíæ</button>
                        <button class="delete-cat" data-id="${cat.id}">‚ùå</button>`;
        list.appendChild(li);
        // Select per prodotti
        const opt = document.createElement("option");
        opt.value = cat.id;
        opt.textContent = cat.name;
        select.appendChild(opt);
    });
}

document.getElementById("add-category-btn").addEventListener("click", async () => {
    const name = document.getElementById("category-name").value.trim();
    const color = document.getElementById("category-color").value;
    const order = parseInt(document.getElementById("category-order").value) || 0;
    if (!name) return;
    await addDoc(collection(db, "categories"), { name, color, order });
    loadCategories();
});

document.getElementById("categories-list").addEventListener("click", async e => {
    if (e.target.classList.contains("save-cat")) {
        const id = e.target.dataset.id;
        const name = document.querySelector(`.edit-cat-name[data-id="${id}"]`).value;
        const color = document.querySelector(`.edit-cat-color[data-id="${id}"]`).value;
        const order = parseInt(document.querySelector(`.edit-cat-order[data-id="${id}"]`).value);
        await updateDoc(doc(db, "categories", id), { name, color, order });
        loadCategories();
    }
    if (e.target.classList.contains("delete-cat")) {
        await deleteDoc(doc(db, "categories", e.target.dataset.id));
        loadCategories();
    }
});

/* =======================
   PRODOTTI
   ======================= */
async function loadProducts() {
    const snap = await getDocs(collection(db, "products"));
    const list = document.getElementById("products-list");
    list.innerHTML = "";
    const prods = [];
    snap.forEach(docSnap => {
        const p = { id: docSnap.id, ...docSnap.data() };
        prods.push(p);
    });
    // Mostra prodotti nelle impostazioni
    prods.forEach(prod => {
        const li = document.createElement("li");
        li.innerHTML = `<input type="text" value="${prod.name}" data-id="${prod.id}" class="edit-prod-name">
                        <input type="number" value="${prod.price}" data-id="${prod.id}" class="edit-prod-price">
                        <input type="number" value="${prod.stock ?? ""}" data-id="${prod.id}" class="edit-prod-stock">
                        <label>Attivo <input type="checkbox" ${prod.active !== false ? "checked" : ""} data-id="${prod.id}" class="edit-prod-active"></label>
                        <button class="save-prod" data-id="${prod.id}">üíæ</button>
                        <button class="delete-prod" data-id="${prod.id}">‚ùå</button>`;
        list.appendChild(li);
    });
    renderProductButtons(prods);
}

document.getElementById("add-product-btn").addEventListener("click", async () => {
    const name = document.getElementById("product-name").value.trim();
    const price = parseFloat(document.getElementById("product-price").value);
    const stock = document.getElementById("product-stock").value;
    const categoryId = document.getElementById("product-category").value;
    if (!name || isNaN(price)) return;
    await addDoc(collection(db, "products"), { name, price, stock: stock || null, categoryId, active: true });
    loadProducts();
});

document.getElementById("products-list").addEventListener("click", async e => {
    if (e.target.classList.contains("save-prod")) {
        const id = e.target.dataset.id;
        const name = document.querySelector(`.edit-prod-name[data-id="${id}"]`).value;
        const price = parseFloat(document.querySelector(`.edit-prod-price[data-id="${id}"]`).value);
        const stock = document.querySelector(`.edit-prod-stock[data-id="${id}"]`).value;
        const active = document.querySelector(`.edit-prod-active[data-id="${id}"]`).checked;
        await updateDoc(doc(db, "products", id), { name, price, stock: stock || null, active });
        loadProducts();
    }
    if (e.target.classList.contains("delete-prod")) {
        await deleteDoc(doc(db, "products", e.target.dataset.id));
        loadProducts();
    }
});

/* =======================
   RENDER BOTTONI HOME
   ======================= */
async function renderProductButtons(products) {
    const catsSnap = await getDocs(collection(db, "categories"));
    const cats = [];
    catsSnap.forEach(docSnap => cats.push({ id: docSnap.id, ...docSnap.data() }));
    cats.sort((a, b) => a.order - b.order);

    const container = document.getElementById("products-container");
    container.innerHTML = "";
    cats.forEach(cat => {
        const catDiv = document.createElement("div");
        catDiv.innerHTML = `<h3>${cat.name}</h3>`;
        products.filter(p => p.categoryId === cat.id && p.active !== false).forEach(prod => {
            const btn = document.createElement("button");
            btn.textContent = prod.name;
            btn.className = "product-btn";
            btn.style.backgroundColor = cat.color;
            btn.addEventListener("click", () => addToCart(prod));
            catDiv.appendChild(btn);
        });
        container.appendChild(catDiv);
    });
}

/* =======================
   CARRELLO E STAMPA
   ======================= */
let cart = [];

function addToCart(prod) {
    const item = cart.find(p => p.id === prod.id);
    if (item) {
        item.qty++;
    } else {
        cart.push({ ...prod, qty: 1 });
    }
    renderCart();
}

function renderCart() {
    const tbody = document.querySelector("#cart-table tbody");
    tbody.innerHTML = "";
    let total = 0;
    cart.forEach(item => {
        const tr = document.createElement("tr");
        total += item.price * item.qty;
        tr.innerHTML = `<td>${item.name}</td><td>${item.qty}</td><td>‚Ç¨ ${item.price.toFixed(2)}</td>
                        <td><button onclick="removeFromCart('${item.id}')">-</button></td>`;
        tbody.appendChild(tr);
    });
    document.getElementById("cart-total").textContent = total.toFixed(2);
}

window.removeFromCart = (id) => {
    const index = cart.findIndex(p => p.id === id);
    if (index > -1) {
        cart[index].qty--;
        if (cart[index].qty <= 0) cart.splice(index, 1);
        renderCart();
    }
};

document.getElementById("print-send").addEventListener("click", async () => {
    if (!cart.length) return;
    const win = window.open("", "PRINT", "height=400,width=600");
    const logoUrl = document.getElementById("bar-logo").src;
    win.document.write(`<html><body style="font-family:monospace; width:80mm">
                        <img src="${logoUrl}" style="max-width:80mm"><h2>Bar San Luigi</h2>
                        <p>${new Date().toLocaleString()}</p><hr>`);
    cart.forEach(item => {
        win.document.write(`<p>${item.name} x${item.qty} - ‚Ç¨ ${(item.price * item.qty).toFixed(2)}</p>`);
    });
    win.document.write(`<hr><h3>TOTALE: ‚Ç¨ ${document.getElementById("cart-total").textContent}</h3></body></html>`);
    win.document.close();
    win.print();

    await addDoc(collection(db, "orders"), {
        date: new Date().toISOString(),
        items: cart.map(c => ({ name: c.name, qty: c.qty, price: c.price }))
    });
    cart = [];
    renderCart();
});

/* =======================
   STORICO ORDINI
   ======================= */
document.getElementById("load-history-btn").addEventListener("click", async () => {
    const dateSel = document.getElementById("history-date").value;
    if (!dateSel) return;
    const snap = await getDocs(collection(db, "orders"));
    const rows = {};
    let total = 0;
    snap.forEach(docSnap => {
        const order = docSnap.data();
        if (order.date.startsWith(dateSel)) {
            order.items.forEach(it => {
                rows[it.name] = (rows[it.name] || 0) + it.qty;
                total += it.qty * it.price;
            });
        }
    });
    const tbody = document.querySelector("#history-table tbody");
    tbody.innerHTML = "";
    Object.entries(rows).forEach(([name, qty]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${name}</td><td>${qty}</td>`;
        tbody.appendChild(tr);
    });
    document.getElementById("history-total").textContent = `‚Ç¨ ${total.toFixed(2)}`;
});

document.getElementById("export-csv-btn").addEventListener("click", () => {
    const rows = [["Prodotto", "Quantit√†"]];
    document.querySelectorAll("#history-table tbody tr").forEach(tr => {
        const cells = Array.from(tr.querySelectorAll("td")).map(td => td.textContent);
        rows.push(cells);
    });
    let csvContent = rows.map(e => e.join(",")).join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "storico.csv";
    link.click();
});

/* Carica logo all'avvio */
loadLogo();
</script>
</body>
</html>
