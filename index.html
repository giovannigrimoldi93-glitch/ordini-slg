<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Bar San Luigi</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f2f2f2;
  }
  header {
    background: #333;
    color: white;
    padding: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  header img {
    max-height: 50px;
  }
  nav {
    display: flex;
    background: #444;
  }
  nav button {
    flex: 1;
    padding: 10px;
    background: #444;
    color: white;
    border: none;
    cursor: pointer;
  }
  nav button.active {
    background: #666;
  }
  .page {
    display: none;
    padding: 10px;
  }
  .page.active {
    display: block;
  }
  .product-btn {
    display: inline-block;
    padding: 10px;
    margin: 5px;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 16px;
    border-radius: 5px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  table, th, td {
    border: 1px solid #ddd;
    padding: 5px;
  }
  #cart-table td button {
    padding: 3px 6px;
  }
</style>
</head>
<body>
<header>
  <img id="bar-logo" src="" alt="Logo">
  <h1>Bar San Luigi</h1>
</header>
<nav>
  <button data-page="home" class="active">Home</button>
  <button data-page="settings">Impostazioni</button>
  <button data-page="history">Storico</button>
</nav>

<!-- PAGINA HOME -->
<div id="home" class="page active">
  <div id="products-container"></div>
  <h2>Carrello</h2>
  <table id="cart-table">
    <thead>
      <tr><th>Prodotto</th><th>Q.tà</th><th>Prezzo</th><th>Azioni</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <h3>Totale: €<span id="cart-total">0.00</span></h3>
  <button id="print-send">Stampa e Salva</button>
</div>

<!-- PAGINA IMPOSTAZIONI -->
<div id="settings" class="page">
  <div id="login-section">
    <input type="password" id="settings-password" placeholder="Password">
    <button id="login-btn">Accedi</button>
  </div>
  <div id="settings-content" style="display:none;">
    <h2>Logo</h2>
    <input type="file" id="logo-input">
    <button id="upload-logo-btn">Carica Logo</button>

    <h2>Categorie</h2>
    <input id="category-name" placeholder="Nome categoria">
    <input type="color" id="category-color" value="#ff0000">
    <input type="number" id="category-order" placeholder="Ordine">
    <button id="add-category-btn">Aggiungi Categoria</button>
    <ul id="categories-list"></ul>

    <h2>Prodotti</h2>
    <input id="product-name" placeholder="Nome prodotto">
    <input type="number" step="0.01" id="product-price" placeholder="Prezzo">
    <input type="number" id="product-stock" placeholder="Stock (opzionale)">
    <select id="product-category"></select>
    <button id="add-product-btn">Aggiungi Prodotto</button>
    <ul id="products-list"></ul>
  </div>
</div>

<!-- PAGINA STORICO -->
<div id="history" class="page">
  <h2>Storico Ordini</h2>
  <input type="date" id="history-date">
  <button id="load-history-btn">Carica Storico</button>
  <button id="export-csv-btn">Esporta CSV</button>
  <table id="history-table">
    <thead><tr><th>Prodotto</th><th>Q.tà</th></tr></thead>
    <tbody></tbody>
  </table>
  <h3>Totale Giornaliero: <span id="history-total">€ 0.00</span></h3>
</div>

  <script>
    // ==== Firebase Config ====
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, setDoc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNtqjDfxsV8TccejiE5Clffd1GvajryiU",
  authDomain: "bar-san-luigi.firebaseapp.com",
  projectId: "bar-san-luigi",
  storageBucket: "bar-san-luigi.firebasestorage.app",
  messagingSenderId: "26384635672",
  appId: "1:26384635672:web:672d98a954aa7e5dcaf06d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let logoURL = "";
let categories = [];
let products = [];
let cart = [];
let ordersCollection = collection(db, "orders");

// ==== Navigazione a schede ====
document.querySelectorAll("nav button").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    document.getElementById(btn.dataset.page).classList.add("active");
  });
});

// ==== Caricamento Logo ====
async function loadLogo() {
  const docRef = doc(db, "config", "logo");
  const snap = await getDoc(docRef);
  if (snap.exists()) {
    logoURL = snap.data().url;
    document.getElementById("bar-logo").src = logoURL;
  }
}

document.getElementById("upload-logo-btn").addEventListener("click", async () => {
  const file = document.getElementById("logo-input").files[0];
  if (!file) return;
  const storageRef = ref(storage, "logo.png");
  await uploadBytes(storageRef, file);
  logoURL = await getDownloadURL(storageRef);
  await setDoc(doc(db, "config", "logo"), { url: logoURL });
  document.getElementById("bar-logo").src = logoURL;
});

// ==== Login Impostazioni ====
document.getElementById("login-btn").addEventListener("click", () => {
  const pass = document.getElementById("settings-password").value;
  if (pass === "admin") {
    document.getElementById("login-section").style.display = "none";
    document.getElementById("settings-content").style.display = "block";
  } else {
    alert("Password errata");
  }
});

// ==== Gestione Categorie ====
async function loadCategories() {
  const snap = await getDocs(collection(db, "categories"));
  categories = [];
  snap.forEach(docu => {
    categories.push({ id: docu.id, ...docu.data() });
  });
  categories.sort((a, b) => a.order - b.order);
  renderCategories();
  renderCategoryOptions();
  renderProductsHome();
}

function renderCategories() {
  const list = document.getElementById("categories-list");
  list.innerHTML = "";
  categories.forEach(cat => {
    const li = document.createElement("li");
    li.innerHTML = `${cat.name} <button onclick="editCategory('${cat.id}')">Modifica</button> <button onclick="deleteCategory('${cat.id}')">Elimina</button>`;
    list.appendChild(li);
  });
}

function renderCategoryOptions() {
  const select = document.getElementById("product-category");
  select.innerHTML = "";
  categories.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat.id;
    opt.textContent = cat.name;
    select.appendChild(opt);
  });
}

document.getElementById("add-category-btn").addEventListener("click", async () => {
  const name = document.getElementById("category-name").value;
  const color = document.getElementById("category-color").value;
  const order = parseInt(document.getElementById("category-order").value) || 0;
  if (!name) return;
  await addDoc(collection(db, "categories"), { name, color, order });
  loadCategories();
});

window.editCategory = async function (id) {
  const cat = categories.find(c => c.id === id);
  if (!cat) return;
  const newName = prompt("Nuovo nome:", cat.name);
  if (newName === null) return;
  const newColor = prompt("Nuovo colore:", cat.color);
  const newOrder = parseInt(prompt("Nuovo ordine:", cat.order)) || 0;
  await updateDoc(doc(db, "categories", id), { name: newName, color: newColor, order: newOrder });
  loadCategories();
};

window.deleteCategory = async function (id) {
  if (!confirm("Eliminare categoria?")) return;
  await deleteDoc(doc(db, "categories", id));
  loadCategories();
};

// ==== Gestione Prodotti ====
async function loadProducts() {
  const snap = await getDocs(collection(db, "products"));
  products = [];
  snap.forEach(docu => {
    products.push({ id: docu.id, ...docu.data() });
  });
  renderProductsList();
  renderProductsHome();
}

function renderProductsList() {
  const list = document.getElementById("products-list");
  list.innerHTML = "";
  products.forEach(prod => {
    const li = document.createElement("li");
    li.innerHTML = `${prod.name} (€${prod.price.toFixed(2)}) [${prod.active ? "Attivo" : "Disattivo"}] 
      <button onclick="toggleProduct('${prod.id}', ${!prod.active})">${prod.active ? "Disattiva" : "Attiva"}</button>
      <button onclick="editProduct('${prod.id}')">Modifica</button>
      <button onclick="deleteProduct('${prod.id}')">Elimina</button>`;
    list.appendChild(li);
  });
}

document.getElementById("add-product-btn").addEventListener("click", async () => {
  const name = document.getElementById("product-name").value;
  const price = parseFloat(document.getElementById("product-price").value) || 0;
  const stock = parseInt(document.getElementById("product-stock").value) || null;
  const category = document.getElementById("product-category").value;
  if (!name) return;
  await addDoc(collection(db, "products"), { name, price, stock, category, active: true });
  loadProducts();
});

window.toggleProduct = async function (id, active) {
  await updateDoc(doc(db, "products", id), { active });
  loadProducts();
};

window.editProduct = async function (id) {
  const prod = products.find(p => p.id === id);
  if (!prod) return;
  const newName = prompt("Nuovo nome:", prod.name);
  if (newName === null) return;
  const newPrice = parseFloat(prompt("Nuovo prezzo:", prod.price)) || 0;
  const newStock = parseInt(prompt("Nuovo stock:", prod.stock || "")) || null;
  await updateDoc(doc(db, "products", id), { name: newName, price: newPrice, stock: newStock });
  loadProducts();
};

window.deleteProduct = async function (id) {
  if (!confirm("Eliminare prodotto?")) return;
  await deleteDoc(doc(db, "products", id));
  loadProducts();
};

// ==== Home — Bottoni Prodotti ====
function renderProductsHome() {
  const container = document.getElementById("products-container");
  container.innerHTML = "";
  categories.forEach(cat => {
    const catProducts = products.filter(p => p.category === cat.id && p.active);
    catProducts.forEach(prod => {
      const btn = document.createElement("button");
      btn.className = "product-btn";
      btn.style.background = cat.color;
      btn.textContent = `${prod.name} (€${prod.price.toFixed(2)})`;
      btn.onclick = () => addToCart(prod);
      container.appendChild(btn);
    });
  });
}

// ==== Carrello ====
function addToCart(prod) {
  const existing = cart.find(item => item.id === prod.id);
  if (existing) {
    existing.qty++;
  } else {
    cart.push({ ...prod, qty: 1 });
  }
  renderCart();
}

function renderCart() {
  const tbody = document.querySelector("#cart-table tbody");
  tbody.innerHTML = "";
  let total = 0;
  cart.forEach((item, idx) => {
    total += item.price * item.qty;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${item.name}</td><td>${item.qty}</td><td>€${(item.price * item.qty).toFixed(2)}</td>
      <td><button onclick="removeFromCart(${idx})">-</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("cart-total").textContent = total.toFixed(2);
}

window.removeFromCart = function (idx) {
  cart.splice(idx, 1);
  renderCart();
};

// ==== Stampa & Salva ====
document.getElementById("print-send").addEventListener("click", async () => {
  if (cart.length === 0) return;
  const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
  const order = { items: cart, total, date: new Date().toISOString() };
  await addDoc(ordersCollection, order);
  printReceipt(order);
  cart = [];
  renderCart();
});

function printReceipt(order) {
  const win = window.open("", "", "width=300,height=600");
  win.document.write(`
    <html>
    <head>
      <title>Scontrino</title>
      <style>
        body { width:80mm; font-family: monospace; font-size: 12px; margin:0; padding:0; }
        img { max-width: 100%; display:block; margin:auto; }
        h2, small { text-align:center; margin:0; }
        hr { border:none; border-top:1px dashed #000; margin:5px 0; }
        @media print { body { margin:0; padding:0; } }
      </style>
    </head>
    <body>
  `);
  if (logoURL) win.document.write(`<img src="${logoURL}"><br>`);
  win.document.write("<h2>Bar San Luigi</h2>");
  win.document.write(`<small>${new Date().toLocaleString()}</small><hr>`);
  order.items.forEach(i => {
    const name = i.name.padEnd(20, " ");
    const price = `€${(i.price * i.qty).toFixed(2)}`.padStart(8, " ");
    win.document.write(`${name} x${i.qty} ${price}<br>`);
  });
  win.document.write("<hr>");
  win.document.write(`<strong>TOTALE: €${order.total.toFixed(2)}</strong>`);
  win.document.write("</body></html>");
  win.document.close();
  win.print();
}

// ==== Storico Ordini ====
document.getElementById("load-history-btn").addEventListener("click", loadHistory);

async function loadHistory() {
  const dateSel = document.getElementById("history-date").value;
  if (!dateSel) return;
  const snap = await getDocs(ordersCollection);
  let productsCount = {};
  let total = 0;
  snap.forEach(docu => {
    const data = docu.data();
    const d = new Date(data.date);
    const localDate = d.toISOString().split("T")[0];
    if (localDate === dateSel) {
      data.items.forEach(item => {
        productsCount[item.name] = (productsCount[item.name] || 0) + item.qty;
        total += item.price * item.qty;
      });
    }
  });
  const tbody = document.querySelector("#history-table tbody");
  tbody.innerHTML = "";
  Object.keys(productsCount).forEach(name => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${name}</td><td>${productsCount[name]}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("history-total").textContent = "€ " + total.toFixed(2);
}

// ==== Export CSV ====
document.getElementById("export-csv-btn").addEventListener("click", () => {
  const rows = [["Prodotto", "Quantità"]];
  document.querySelectorAll("#history-table tbody tr").forEach(tr => {
    const cols = tr.querySelectorAll("td");
    rows.push([cols[0].innerText, cols[1].innerText]);
  });
  let csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "storico.csv";
  a.click();
  URL.revokeObjectURL(url);
});

// ==== Init ====
loadLogo();
loadCategories();
loadProducts();
  </script>
  
</body>
</html>
