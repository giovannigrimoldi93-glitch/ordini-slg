<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bar San Luigi</title>
<style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f3f3f3; }
    header { background: #3f51b5; color: #fff; padding: 10px; text-align: center; }
    header img { max-height: 60px; display: block; margin: 0 auto 5px; }
    nav { display: flex; background: #283593; }
    nav button { flex: 1; padding: 10px; border: none; background: #283593; color: #fff; font-size: 16px; cursor: pointer; }
    nav button.active { background: #1a237e; }
    .page { display: none; padding: 15px; }
    .page.active { display: block; }
    .products { display: flex; flex-wrap: wrap; }
    .products button { flex: 1 0 30%; margin: 5px; padding: 20px; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; color: #fff; }
    .cart { background: #fff; padding: 10px; margin-top: 15px; border-radius: 5px; }
    .cart table { width: 100%; border-collapse: collapse; }
    .cart th, .cart td { padding: 5px; border-bottom: 1px solid #ddd; text-align: center; }
    .total { text-align: right; font-size: 18px; font-weight: bold; }
    button.print { background: #4caf50; color: #fff; border: none; padding: 10px; margin-top: 10px; cursor: pointer; font-size: 16px; border-radius: 5px; width: 100%; }
    input, select { margin: 5px 0; padding: 5px; width: 100%; }
    ul { list-style: none; padding: 0; }
    li { margin-bottom: 5px; }
</style>
</head>
<body>
<header>
    <img id="barLogo" alt="Logo Bar San Luigi">
    <h1>Bar San Luigi</h1>
</header>
<nav>
    <button data-page="home" class="active">Home</button>
    <button data-page="settings">Impostazioni</button>
    <button data-page="history">Storico ordini</button>
</nav>

<!-- HOME -->
<div id="home" class="page active">
    <div class="products" id="productsContainer"></div>
    <div class="cart">
        <table id="cartTable">
            <thead><tr><th>Prodotto</th><th>Qtà</th><th>Prezzo</th><th></th></tr></thead>
            <tbody></tbody>
        </table>
        <div class="total">Totale: € <span id="totalPrice">0.00</span></div>
        <button class="print" id="printAndSend">Stampa e invia</button>
    </div>
</div>

<!-- IMPOSTAZIONI -->
<div id="settings" class="page">
    <div id="loginSettings">
        <input type="password" id="settingsPassword" placeholder="Password">
        <button id="loginBtn">Accedi</button>
    </div>
    <div id="settingsContent" style="display:none;">
        <h2>Categorie</h2>
        <input id="catName" placeholder="Nome categoria">
        <input type="color" id="catColor" value="#3f51b5">
        <input type="number" id="catOrder" placeholder="Ordine esposizione">
        <button id="addCategory">Aggiungi categoria</button>
        <ul id="categoriesList"></ul>
        <h2>Prodotti</h2>
        <input id="prodName" placeholder="Nome prodotto">
        <input type="number" id="prodPrice" placeholder="Prezzo">
        <input type="number" id="prodQty" placeholder="Quantità (vuoto = illimitata)">
        <select id="prodCategory"></select>
        <label><input type="checkbox" id="prodEnabled" checked> Abilitato</label>
        <button id="addProduct">Aggiungi prodotto</button>
        <ul id="productsList"></ul>
        <h2>Logo</h2>
        <input type="file" id="logoUpload">
        <button id="clearLogoBtn">Rimuovi logo</button>
    </div>
</div>

<!-- STORICO -->
<div id="history" class="page">
    <h2>Storico ordini</h2>
    <input type="date" id="historyDate">
    <button id="loadHistory">Vai!</button>
    <table id="historyTable">
        <thead><tr><th>Prodotto</th><th>Qtà</th></tr></thead>
        <tbody></tbody>
    </table>
    <div class="total">Totale incasso: € <span id="historyTotal">0.00</span></div>
    <button id="exportCSV">Esporta CSV</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, deleteDoc, updateDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNtqjDfxsV8TccejiE5Clffd1GvajryiU",
  authDomain: "bar-san-luigi.firebaseapp.com",
  projectId: "bar-san-luigi",
  storageBucket: "bar-san-luigi.firebasestorage.app",
  messagingSenderId: "26384635672",
  appId: "1:26384635672:web:672d98a954aa7e5dcaf06d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let categories = [];
let products = [];
let cart = [];

// LOGO
async function loadLogo(){
    try {
        const snap = await getDoc(doc(db,'config','logo'));
        if(snap.exists() && snap.data().url){
            document.getElementById("barLogo").src = snap.data().url;
        }
    } catch(e){ console.error(e); }
}
document.getElementById("logoUpload").onchange = async e=>{
    const f = e.target.files[0];
    if(!f) return;
    const refPath = storageRef(storage, 'logos/barLogo.jpg');
    await uploadBytes(refPath, f);
    const url = await getDownloadURL(refPath);
    await setDoc(doc(db,'config','logo'), {url});
    document.getElementById("barLogo").src = url;
};
document.getElementById("clearLogoBtn").onclick = async ()=>{
    const refPath = storageRef(storage, 'logos/barLogo.jpg');
    await deleteObject(refPath);
    await setDoc(doc(db,'config','logo'), {url:null});
    document.getElementById("barLogo").src = '';
};

// CATEGORIE
async function loadCategories(){
    const q = query(collection(db,'categories'), orderBy('order','asc'));
    const snap = await getDocs(q);
    categories = snap.docs.map(d=>({id:d.id, ...d.data()}));
    renderCategoriesSettings();
    renderProductsList();
}
function renderCategoriesSettings(){
    const list = document.getElementById("categoriesList");
    const sel = document.getElementById("prodCategory");
    list.innerHTML = ''; sel.innerHTML = '';
    categories.forEach(cat=>{
        const li = document.createElement("li");
        li.innerHTML = `<span style="color:${cat.color}">${cat.name}</span>
        <button onclick="editCategory('${cat.id}')">Modifica</button>
        <button onclick="deleteCategory('${cat.id}')">Elimina</button>`;
        list.appendChild(li);
        const opt = document.createElement("option");
        opt.value = cat.id; opt.textContent = cat.name;
        sel.appendChild(opt);
    });
}
window.editCategory = async id=>{
    const cat = categories.find(c=>c.id===id);
    const name = prompt("Nome categoria", cat.name);
    const color = prompt("Colore HEX", cat.color);
    const order = parseInt(prompt("Ordine", cat.order))||0;
    await updateDoc(doc(db,'categories',id), {name, color, order});
    loadCategories();
};
window.deleteCategory = async id=>{
    await deleteDoc(doc(db,'categories',id));
    loadCategories();
};
document.getElementById("addCategory").onclick = async ()=>{
    const name = document.getElementById("catName").value;
    const color = document.getElementById("catColor").value;
    const order = parseInt(document.getElementById("catOrder").value)||0;
    await addDoc(collection(db,'categories'), {name,color,order});
    loadCategories();
};

// PRODOTTI
async function loadProducts(){
    const snap = await getDocs(collection(db,'products'));
    products = snap.docs.map(d=>({id:d.id, ...d.data()}));
    renderProductsList();
    renderProductsHome();
}
function renderProductsList(){
    const list = document.getElementById("productsList");
    list.innerHTML = '';
    products.forEach(prod=>{
        const li = document.createElement("li");
        li.textContent = `${prod.name} (€${prod.price}) - ${prod.enabled?"Attivo":"Disattivo"}`;
        li.innerHTML += ` <button onclick="editProduct('${prod.id}')">Modifica</button>
        <button onclick="deleteProduct('${prod.id}')">Elimina</button>
        <button onclick="toggleProduct('${prod.id}')">${prod.enabled?"Disattiva":"Attiva"}</button>`;
        list.appendChild(li);
    });
}
function renderProductsHome(){
    const container = document.getElementById("productsContainer");
    container.innerHTML = '';
    categories.forEach(cat=>{
        products.filter(p=>p.category===cat.id && p.enabled).forEach(prod=>{
            const btn = document.createElement("button");
            btn.textContent = prod.name;
            btn.style.background = cat.color;
            btn.onclick = ()=>addToCart(prod);
            container.appendChild(btn);
        });
    });
}
window.editProduct = async id=>{
    const prod = products.find(p=>p.id===id);
    const name = prompt("Nome", prod.name);
    const price = parseFloat(prompt("Prezzo", prod.price));
    const qty = prompt("Quantità", prod.qty??'');
    await updateDoc(doc(db,'products',id), {name,price,qty:qty===''?null:parseInt(qty)});
    loadProducts();
};
window.deleteProduct = async id=>{
    await deleteDoc(doc(db,'products',id));
    loadProducts();
};
window.toggleProduct = async id=>{
    const prod = products.find(p=>p.id===id);
    await updateDoc(doc(db,'products',id), {enabled:!prod.enabled});
    loadProducts();
};
document.getElementById("addProduct").onclick = async ()=>{
    const name = document.getElementById("prodName").value;
    const price = parseFloat(document.getElementById("prodPrice").value);
    const qty = document.getElementById("prodQty").value;
    const category = document.getElementById("prodCategory").value;
    const enabled = document.getElementById("prodEnabled").checked;
    await addDoc(collection(db,'products'), {name,price,qty:qty===''?null:parseInt(qty),category,enabled});
    loadProducts();
};

// CARRELLO
function addToCart(prod){
    const found = cart.find(i=>i.id===prod.id);
    if(found){ found.qty++; } else { cart.push({...prod, qty:1}); }
    renderCart();
}
function renderCart(){
    const tbody = document.querySelector("#cartTable tbody");
    tbody.innerHTML = '';
    let total = 0;
    cart.forEach((item,i)=>{
        total += item.price * item.qty;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${item.name}</td><td>${item.qty}</td><td>€${(item.price*item.qty).toFixed(2)}</td>
        <td><button onclick="removeFromCart(${i})">-</button></td>`;
        tbody.appendChild(tr);
    });
    document.getElementById("totalPrice").textContent = total.toFixed(2);
}
window.removeFromCart = idx=>{
    cart[idx].qty--;
    if(cart[idx].qty<=0) cart.splice(idx,1);
    renderCart();
};

// STAMPA
document.getElementById("printAndSend").onclick = async ()=>{
    if(cart.length===0) return;
    const orderNum = Date.now();
    const date = new Date().toLocaleString();
    const total = document.getElementById("totalPrice").textContent;
    let content = `<div style="width:80mm;font-family:monospace;text-align:center">
    ${document.getElementById("barLogo").src?`<img src="${document.getElementById("barLogo").src}" style="max-width:60mm"><br>`:''}
    <h2>Bar San Luigi</h2>${date}<br>Ordine #${orderNum}<hr>`;
    cart.forEach(i=>{ content += `${i.qty} x ${i.name} .... €${(i.price*i.qty).toFixed(2)}<br>`; });
    content += `<hr><b>TOTALE: €${total}</b></div>`;
    const w = window.open('', 'PRINT', 'height=400,width=600');
    w.document.write(content);
    w.print();
    w.close();
    await addDoc(collection(db,'orders'), {date: new Date(), items:cart, total:parseFloat(total)});
    cart = [];
    renderCart();
};

// STORICO
document.getElementById("loadHistory").onclick = async ()=>{
    const dateVal = document.getElementById("historyDate").value;
    if(!dateVal) return;
    const start = new Date(dateVal+"T00:00:00");
    const end = new Date(dateVal+"T23:59:59");
    const q = query(collection(db,'orders'), where('date','>=',start), where('date','<=',end));
    const snap = await getDocs(q);
    const summary = {};
    let total = 0;
    snap.forEach(docSnap=>{
        docSnap.data().items.forEach(item=>{
            summary[item.name] = (summary[item.name]||0)+item.qty;
            total += item.price*item.qty;
        });
    });
    const tbody = document.querySelector("#historyTable tbody");
    tbody.innerHTML = '';
    Object.keys(summary).forEach(k=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${k}</td><td>${summary[k]}</td>`;
        tbody.appendChild(tr);
    });
    document.getElementById("historyTotal").textContent = total.toFixed(2);
};
document.getElementById("exportCSV").onclick = ()=>{
    let csv = "Prodotto,Quantità\n";
    document.querySelectorAll("#historyTable tbody tr").forEach(tr=>{
        const tds = tr.querySelectorAll("td");
        csv += `${tds[0].textContent},${tds[1].textContent}\n`;
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "storico.csv";
    a.click();
    URL.revokeObjectURL(url);
};

// LOGIN
document.getElementById("loginBtn").onclick = ()=>{
    if(document.getElementById("settingsPassword").value==="admin"){
        document.getElementById("loginSettings").style.display="none";
        document.getElementById("settingsContent").style.display="block";
    } else { alert("Password errata"); }
};

// NAV
document.querySelectorAll("nav button").forEach(btn=>{
    btn.onclick = ()=>{
        document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
        document.getElementById(btn.dataset.page).classList.add("active");
    };
});

// LOAD INIT
await loadLogo();
await loadCategories();
await loadProducts();
</script>
</body>
</html>
